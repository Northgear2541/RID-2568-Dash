<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Dashboard สถานะงาน</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Th+Sarabun+PSK&display=swap');

        body { 
            font-family: 'Th Sarabun PSK', 'Sarabun', sans-serif;
            background: #f0f0f0; 
            padding: 20px; 
            font-size: 18px; 
        }
        table { width:100%; border-collapse: collapse; }
        #statusTable, #statusTable th, #statusTable td {
            font-family: 'Th Sarabun PSK', 'Sarabun', sans-serif !important;
            font-size: 16px; 
        }
        /* Style for column filters */
        #statusTable tfoot input, #statusTable tfoot select {
            width: 100%;
            padding: 3px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-family: 'Th Sarabun PSK', sans-serif; /* Ensure filter inputs also use the font */
            font-size: 14px; /* Adjust size for filters */
        }
        /* Color styles for background */
        .status-รอตรวจสอบ { background-color: #FFF3CD; }
        .status-ตรวจสอบผ่าน { background-color: #D4EDDA; }
        .status-วางบิล { background-color: #E0E0E0; }
        .status-จ่ายเงิน { background-color: #D1ECF1; }
        .status-อยู่ระหว่างตรวจ { background-color: #FFE0B2; }
        .status-อนุมัติจัดพิมพ์ { background-color: #C8E6C9; }
        .status-ตรวจติดตามผ่าน { background-color: #B2DFDB; }
        .status-ตรวจประเมินผ่าน { background-color: #C5E1A5; }
        .status-ปิดโครงการ { background-color: #BDBDBD; }

        /* === เพิ่ม/แก้ไข CSS สำหรับสีตัวอักษรเป็นสีแดง === */
        .status-ส่งเข้าระบบซ้ำกัน,
        .status-ตรวจสอบไม่ผ่าน,
        .status-ตรวจติดตามไม่ผ่าน,
        .status-ตรวจประเมินไม่ผ่าน { 
            background-color: #F8D7DA; /* อาจจะใช้สีแดงอ่อนเดิม หรือเปลี่ยนเป็นสีอื่น */
            color: red; /* กำหนดสีตัวอักษรเป็นสีแดง */
            font-weight: bold; /* อาจจะเพิ่มตัวหนาเพื่อเน้นมากขึ้น */
        }
        /* ถ้าสถานะ 'ตรวจสอบไม่ผ่าน' มีการกำหนด background-color เดิมอยู่แล้ว
           ให้มั่นใจว่า class 'status-ตรวจสอบไม่ผ่าน' ที่มี 'color: red;' อยู่ข้างล่างหรือมี !important */
        /* หรือคุณสามารถกำหนด background-color ใหม่สำหรับสถานะเหล่านี้ได้เลย */
        /* ตัวอย่าง: ถ้าต้องการพื้นหลังสีชมพูอ่อน และตัวอักษรสีแดง */
        /* .status-ตรวจสอบไม่ผ่าน { background-color: #FFCDD2; color: red; font-weight: bold; } */
        /* สำหรับ 'ตรวจสอบไม่ผ่าน' และ 'ตรวจติดตามไม่ผ่าน' ผมได้กำหนด background-color เดิมไว้แล้ว
           ดังนั้นแค่เพิ่ม color: red; ก็พอ แต่ผมรวมไว้ในกลุ่มเดียวกัน */

    </style>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
</head>
<body>
    <h2>Dashboard สถานะงาน</h2>
    <table id="statusTable" class="display nowrap">
        <thead>
            <tr>
                <th>ประทับเวลา</th>
                <th>ชื่อเครื่องจักร</th>
                <th>รายการดำเนินการ</th>
                <th>สถานะงาน</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr>
                <th>ประทับเวลา</th>
                <th>ชื่อเครื่องจักร</th>
                <th>รายการดำเนินการ</th>
                <th>สถานะงาน</th>
            </tr>
        </tfoot>
    </table>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
        let dataTable; 

        function loadData() {
            const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRvcrOwNXXon7ub2437NZh70H6rkwxqBeS_x1QHJtzFHiS3EJ9Qk9ClY2p6GLzy2kNanEzK_MIyJW0T/pub?gid=1224553793&single=true&output=csv&t=" + new Date().getTime();

            fetch(csvUrl)
                .then(r => r.text())
                .then(text => {
                    const rawData = Papa.parse(text, { header: true }).data;
                    const processedData = [];

                    rawData.forEach(r => {
                        const t = r["ประทับเวลา"]?.trim();
                        const m = r["ชื่อเครื่องจักรตามสัญญาฯโครงการของท่าน"]?.trim();
                        const a = r["โปรดเลือกรายการที่จะดำเนินการ"]?.trim();
                        const s = r["สถานะงาน"]?.trim();
                        if (t && m && a && s) {
                            processedData.push([t, m, a, s]);
                        }
                    });

                    if ($.fn.DataTable.isDataTable('#statusTable')) {
                        dataTable.destroy();
                        $('#statusTable tbody').empty();
                        $('#statusTable tfoot th').empty();
                    } 
                    
                    dataTable = $('#statusTable').DataTable({
                        dom: 'lBfrtip',
                        buttons: ['excelHtml5'],
                        lengthMenu: [
                            [10, 20, -1], 
                            ['10 แถว', '20 แถว', 'แสดงทั้งหมด']
                        ],
                        language: {
                            search: "ค้นหา:", 
                            lengthMenu: "แสดง _MENU_ แถว", 
                            info: "แสดง _START_ ถึง _END_ จาก _TOTAL_ แถว",
                            zeroRecords: "ไม่พบข้อมูล",
                            paginate: { first: "หน้าแรก", last: "หน้าสุดท้าย", next: "ถัดไป", previous: "ก่อนหน้า" }
                        },
                        data: processedData,
                        rowCallback: function(row, data, index) {
                            const status = data[3]; 
                            $(row).addClass("status-" + status);
                        },
                        initComplete: function () {
                            this.api().columns().every(function () {
                                const column = this;
                                const columnIndex = column.index();
                                let filterElement;

                                if (columnIndex === 2 || columnIndex === 3) { 
                                    filterElement = $('<select><option value="">--เลือก--</option></select>')
                                        .appendTo($(column.footer()).empty())
                                        .on('change', function () {
                                            const val = $.fn.dataTable.util.escapeRegex($(this).val());
                                            column.search(val ? '^' + val + '$' : '', true, false).draw();
                                        });

                                    column.data().unique().sort().each(function (d, j) {
                                        filterElement.append('<option value="' + d + '">' + d + '</option>');
                                    });
                                } else { 
                                    filterElement = $('<input type="text" placeholder="ค้นหา ' + $(column.header()).text() + '" />')
                                        .appendTo($(column.footer()).empty())
                                        .on('keyup change', function () {
                                            if (column.search() !== this.value) {
                                                column.search(this.value).draw();
                                            }
                                        });
                                }
                            });
                        }
                    });
                })
                .catch(err => console.error("เกิดข้อผิดพลาดดึงข้อมูล CSV:", err));
        }

        $(document).ready(function() {
            loadData(); 
            setInterval(loadData, 300000); 
        });
    </script>
</body>
</html>
